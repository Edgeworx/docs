{{ $currentSection := .CurrentSection }}
{{ $sectionPages := .CurrentSection.Pages}}
{{ $currentPage := . -}}
{{ $isIndex := eq .RelPermalink $currentSection.RelPermalink }}
{{ $pageIndex := -1 }}

{{ $prevIndex := -1}}
{{ $prevLink := "" }}
{{ $prevTitle := "" }}
{{ $prevArrow := "&larr;" }}

{{ $nextIndex := -1 }}
{{ $nextLink := "" }}
{{ $nextTitle := "" }}
{{ $nextArrow := "&rarr;" }}

{{define "nextSib"}}
    {{/* nextSib expects a page arg, and sets .Scratch "nextSib" if there
     is a next sibling page (at the same level of hierarchy) */}}

    {{$p:= .}}
    {{$foundMe := false }}
    {{if eq $p.RelPermalink .CurrentSection.RelPermalink}}
        {{/* We need this special check for index pages */}}
        {{$foundMe = true}}
    {{end}}

    {{ range $i, $item := .CurrentSection.Pages }}
        {{ if eq $p.RelPermalink $item.RelPermalink }}
            {{ $foundMe = true }}
            {{continue}}
        {{ end }}

        {{ if ne $foundMe true}}{{continue}}{{end}}

        {{ with $item.Params.externalLink}}
            {{/* If it's an external link, we don't want it to show up in nav */}}
            {{continue}}
        {{end}}

        {{ $p.Scratch.Set "nextSib" $item}}
        {{ break }}
    {{end}}
{{end}}

{{define "nextAunt"}}
    {{$p := .}}
    {{$parent := .GetPage ".."}}
    {{$currentSection := $p.CurrentSection}}
    {{$parentSection := $parent.CurrentSection}}

    {{$foundMe := false}}
    {{ range $i, $item := $parentSection.Pages }}
        {{ if eq $currentSection.RelPermalink $item.RelPermalink }}
            {{ $foundMe = true }}
            {{continue}}
        {{ end }}

        {{ if ne $foundMe true}}{{continue}}{{end}}

        {{ with $item.Params.externalLink}}
            {{/* If it's an external link, we don't want it to show up in nav */}}
            {{continue}}
        {{end}}

        {{ $p.Scratch.Set "nextAunt" $item}}
        {{ break }}
    {{end}}
{{end}}


{{define "prevSib"}}
    {{/* prevSib expects a page arg, and sets .Scratch "prevSib" if there
     is a prev sibling page (at the same level of hierarchy) */}}

    {{$p:= .}}

    {{if eq $p.RelPermalink .CurrentSection.RelPermalink}}
        {{/* We need this special check for index pages. If this is the index page, there is no previous sib */}}
    {{else}}

        {{$currentSection := .GetPage .CurrentSection.RelPermalink}}
        {{$p.Scratch.Set "prevSib" $currentSection}}

        {{ range $i, $item := .CurrentSection.Pages }}

            {{ with $item.Params.externalLink}}

              {{/* If it's an external link, we don't want it to show up in nav */}}
              {{continue}}
            {{end}}

            {{ if eq $p.RelPermalink $item.RelPermalink }}
                {{/* We've gone too far, we've reached the page itself */}}
                {{ break }}
            {{ end }}

            {{ $p.Scratch.Set "prevSib" $item}}
        {{end}}
    {{end}}
{{end}}

{{define "setSibs"}}
    {{/*
    setSibs expects a page arg. It invokes nextSib and prevSib, resulting
    in .Scratch "prevSib" and "nextSib" being set to the prev/next page object
    (at the same hierarchy level) or nil.
    */}}

    {{$p:= .}}
    {{- template "prevSib" $p -}}
    {{- template "nextSib" $p -}}

    {{ $isIndex := eq $p.RelPermalink $p.CurrentSection.RelPermalink }}
    {{ with $isIndex }}
        {{$p.Scratch.Set "isIndex" true}}
        {{$p.Scratch.Set "parentPage" $p}}
    {{else}}
        {{$p.Scratch.Set "isIndex" false}}
        {{ $parent := $p.GetPage ".." }}
        {{ $p.Scratch.Set "parentPage" $parent}}
    {{end}}

    {{- template "nextAunt" $p -}}

    {{with $p.Scratch.Get "nextSib"}}
        {{$p.Scratch.Set "nextLink" .}}
        {{$p.Scratch.Set "nextArrow" "&rarr;"}}
    {{else}}
        {{$p.Scratch.Set "nextLink" ($p.Scratch.Get "nextAunt")}}
        {{$p.Scratch.Set "nextArrow" "&#8599;"}}
    {{end}}
{{end}}




{{- template "setSibs" $currentPage -}}
<pre>
Prev sib: {{ ($currentPage.Scratch.Get "prevSib").RelPermalink}}
Next sib: {{ ($currentPage.Scratch.Get "nextSib").RelPermalink}}
Parent: {{ ($currentPage.Scratch.Get "parentPage").RelPermalink}}
nextAunt: {{ ($currentPage.Scratch.Get "nextAunt").RelPermalink}}
nextLink: {{ ($currentPage.Scratch.Get "nextLink").RelPermalink}}
nextArrow: {{$currentPage.Scratch.Get "nextArrow"}}
IsIndex: {{ ($currentPage.Scratch.Get "isIndex")}}
</pre>






{{/*

Now that we know $pageIndex, we need to figure out $prevIndex and $nextIndex,
noting that both vars could end up being -1, indicating no prev/next.

Also note that we want to exclude "externalLink" pages from prev/next.

*/}}



<pre>
  $pageIndex: {{$pageIndex}}
  $prevIndex: {{$prevIndex}}
  $nextIndex: {{$nextIndex}}
</pre>


{{ $prevLink = ($currentPage.Scratch.Get "prevSib").RelPermalink}}
{{ $prevTitle = ($currentPage.Scratch.Get "prevSib").LinkTitle}}

{{ $nextLink = ($currentPage.Scratch.Get "nextSib").RelPermalink}}
{{ $nextTitle = ($currentPage.Scratch.Get "nextSib").LinkTitle}}



{{ with (or $prevLink $nextLink)}}
  <div class="docs-navigation d-flex justify-content-between">

    {{ with $prevLink }}
      <a href="{{ $prevLink }}">
        <div class="card my-1">
          <div class="card-body py-2">
            {{ $prevArrow | safeHTML}} {{ $prevTitle }}
          </div>
        </div>
      </a>
    {{ end -}}

    {{ with $nextLink }}
    <a class="ms-auto" href="{{ $nextLink }}">
      <div class="card my-1">
        <div class="card-body py-2">
          {{ $nextTitle }} {{ $nextArrow | safeHTML}}
        </div>
      </div>
    </a>
    {{ end -}}

  </div>
{{ end}}

