{{ $currentSection := .CurrentSection }}
{{ $currentPage := . -}}

{{ $nextLink := "" }}
{{ $nextTitle := "" }}
{{ $nextArrow := "&larr;" }}

<div class="docs-navigation d-flex justify-content-between">
  <!--
    CAUTION: due to the funky way that hugo weights work, "Next"
    and "Previous" are opposite to what you'd expect!
    Yeah, I know, it's crazy. -->
  {{ if .NextInSection }}
    {{ $nextLink = .NextInSection.RelPermalink }}
    {{ $nextTitle = .NextInSection.Title }}
  {{ else if .IsSection }}
    {{/*
      We're on a Section page (_index.md), so we need to go up to the
      previous level to find the next item.
    */}}

    {{ $parent := .GetPage ".." }}
    {{ range $i, $item := $parent.Pages }}
      {{ if and (gt $i 0) (eq $item.RelPermalink $currentPage.RelPermalink) }}
        {{ $aunt := index $parent.Pages (sub $i 1) }}
        {{ $nextLink = $aunt.RelPermalink }}
        {{ $nextTitle = $aunt.Title }}
        {{ $nextArrow = "&#8598;" }} {{/* The northwest arrow */}}
       {{ end }}
    {{ end }}
  {{ else }}
    <!-- This is the first non-section page (page 1) of the section -->
    {{ $nextLink = $currentSection.RelPermalink }}
    {{ $nextTitle = $currentSection.Title }}
  {{ end }}

  {{ with $nextLink }}
    <a href="{{ $nextLink }}">
      <div class="card my-1">
        <div class="card-body py-2">
          {{ $nextArrow | safeHTML}} {{ $nextTitle }}
        </div>
      </div>
    </a>
  {{ end -}}


  {{/*
    Now, onto the "previous" section, which is really the NEXT section.
  */}}

  {{ $prevLink := "" }}
  {{ $prevTitle := "" }}
  {{ $prevArrow := "&rarr;" }} {{/* The northeast arrow */}}

  {{ if .PrevInSection -}}
    {{ $prevLink = .PrevInSection.RelPermalink }}
    {{ $prevTitle = .PrevInSection.Title }}
  {{ else if and .IsSection (gt (len .Pages) 0)}}
    {{/*
      Probably on the _index.md section/page?
    */}}
    {{ $p := (index .Pages 0) }}
    {{ $prevLink = $p.RelPermalink }}
    {{ $prevTitle = $p.Title }}
  {{ else }}
    {{/*
      Probably at the end of a section, and we need to go up a level.
    */}}
    {{ $parent := .GetPage ".." }}
    {{ range $i, $item := $parent.Pages }}
      {{ if (eq $item.RelPermalink $currentSection.RelPermalink) }}
        {{ $sibIndex := add $i 1}}
        {{ if lt $sibIndex (len $parent.Pages) }}
          {{ $sib := index $parent.Pages $sibIndex }}
          {{ $prevLink = $sib.RelPermalink }}
          {{ $prevTitle = $sib.Title }}
          {{ $prevArrow = "&#8599;" }} {{/* The northeast arrow */}}
        {{ end }}
      {{  end }}
    {{ end }}
  {{ end -}}

  {{ with $prevLink }}
    <a class="ms-auto" href="{{ $prevLink }}">
      <div class="card my-1">
        <div class="card-body py-2">
          {{ $prevTitle }} {{ $prevArrow | safeHTML}}
        </div>
      </div>
    </a>
  {{ end -}}

</div>
